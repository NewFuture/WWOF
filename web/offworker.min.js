(function(){var g={"function":true,"object":true};var j=g[typeof exports]&&exports&&!exports.nodeType&&exports;var e=g[typeof module]&&module&&!module.nodeType&&module;var d=j&&e&&typeof global=="object"&&global&&global.Object&&global;var b=g[typeof self]&&self&&self.Object&&self;var h=g[typeof window]&&window&&window.Object&&window;var l=e&&e.exports===j&&j;var k=d||((h!==(this&&this.window))&&h)||b||this;var c={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};var i=false;function a(o){var n=document.createElement("A");n.href=o;o=n.href;return o}var m=window.Worker;var f=function(o,p){var n=this._ws=new WebSocket(p||f.DEFAULTSERVER);this.url=o;this.isNative=false;this.collector=[];o=a(o);n.onopen=function(){var q={cmd:1,data:o};i=false;n.send(JSON.stringify(q))};n.onmessage=function(r){var q=JSON.parse(r.data).status;if(q<0){this.goNative();return}if(q==1){this.isReady=true;this.postMessage();return}if(typeof this.onmessage!="function"||!this.isReady){return}else{if(q==2){this.onmessage(JSON.parse(r.data))}}}.bind(this);n.onerror=function(q){this.goNative();if(typeof this.onerror!="function"||!this.isReady){return}else{this.onerror(q)}}.bind(this)};f.prototype.postMessage=function(p){if(this.isNative){p?this.nativeWorker.postMessage(JSON.stringify({cmd:2,data:p})):void 0;return}if(!this.isReady){this.collector.push(p)}else{if(i){return}else{if(this.collector.length){for(var o=0;o<this.collector.length;o++){var n=this.collector[o];this._ws.send(JSON.stringify({cmd:2,data:n}))}this.collector=[]}p?this._ws.send(JSON.stringify({cmd:2,data:p})):void 0}}};f.prototype.terminate=function(){if(this.isNative){this.nativeWorker.terminate();return}if(!this.isReady){setTimeout(function(){this.terminate()}.bind(this))}else{this.postMessage();i=true;this._ws.send(JSON.stringify({cmd:-1,data:"close"}));this.isReady=false;this._ws.close()}};f.prototype.goNative=function(){this.isNative=true;this.nativeWorker=new m(this.url);this.nativeWorker.onmessage=this.onmessage;this.nativeWorker.onerror=this.onerror;while(this.collector.length){var n=this.collector.shift();this.nativeWorker.postMessage(JSON.stringify({cmd:2,data:n}))}};f.DEFAULTSERVER="ws://127.0.0.1:8888";if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){k.Worker=f;define(function(){return f})}else{if(j&&e){if(l){(e.exports=f).Worker=f}else{j.Worker=f}}else{k.Worker=f}}}.call(this));